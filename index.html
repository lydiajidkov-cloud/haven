<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d1b2a">
    <title>Haven</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/island.css">
    <link rel="stylesheet" href="css/shop.css">
    <link rel="stylesheet" href="css/tiles.css">
    <link rel="stylesheet" href="css/tutorial.css">
    <link rel="stylesheet" href="css/recipes.css">
    <link rel="stylesheet" href="css/welcome.css">
    <link rel="stylesheet" href="css/combo.css">
    <link rel="stylesheet" href="css/daily.css">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="css/achievements.css">
    <link rel="stylesheet" href="css/celebration.css">
</head>
<body>
    <div id="app">
        <!-- Top Bar -->
        <header id="top-bar">
            <div id="energy-display">
                <span class="energy-icon">âš¡</span>
                <span id="energy-count">100</span>/<span id="energy-max">100</span>
                <span id="energy-timer" class="hidden"></span>
            </div>
            <h1 id="game-title">Haven</h1>
            <div style="display:flex;align-items:center;gap:6px;">
                <div id="stars-display">
                    <span class="stars-icon">â­</span>
                    <span id="stars-count">0</span>
                </div>
                <div id="gems-display">
                    <span class="gems-icon">ğŸ’</span>
                    <span id="gems-count">50</span>
                </div>
                <button id="achievements-btn" title="Achievements">ğŸ†<span id="achievements-badge" class="hidden">0</span></button>
                <button id="settings-btn" class="settings-gear" title="Settings">âš™ï¸</button>
            </div>
        </header>

        <!-- Screens -->
        <main id="screens">
            <!-- Board Screen -->
            <div id="board-screen" class="screen active">
                <div id="board-hint" class="board-hint">
                    ğŸ‘‡ Tap a resource button below to spawn items, then drag matching items together to merge!
                </div>
                <div id="surge-bar" class="hidden">
                    <div id="surge-fill"></div>
                    <span id="surge-label"></span>
                </div>
                <div id="powerup-bar"></div>
                <div id="orders-panel"></div>
                <div id="board-wrapper">
                    <div id="board-container">
                        <canvas id="particle-canvas"></canvas>
                        <div id="board"></div>
                    </div>
                </div>

                <!-- Companion Bar (2 slots, between board and resource nodes) -->
                <div id="companion-bar" style="display:none;">
                    <div class="companion-slot empty" data-slot="slot1"><span class="companion-plus">+</span></div>
                    <div class="companion-slot empty" data-slot="slot2"><span class="companion-plus">+</span></div>
                </div>

                <!-- Resource Nodes -->
                <div id="resource-nodes">
                    <button class="node" data-chain="wood">
                        <span class="node-icon">ğŸŒ²</span>
                        <span class="node-label">Wood</span>
                    </button>
                    <button class="node" data-chain="stone">
                        <span class="node-icon">â›°ï¸</span>
                        <span class="node-label">Stone</span>
                    </button>
                    <button class="node" data-chain="flora">
                        <span class="node-icon">ğŸŒ¸</span>
                        <span class="node-label">Flora</span>
                    </button>
                    <button class="node" data-chain="crystal">
                        <span class="node-icon">ğŸ’</span>
                        <span class="node-label">Crystal</span>
                    </button>
                    <button class="node" data-chain="creature">
                        <span class="node-icon">ğŸ¥š</span>
                        <span class="node-label">Egg</span>
                    </button>
                </div>
            </div>

            <!-- Quest Screen -->
            <div id="quest-screen" class="screen">
                <div class="quest-header-bar">
                    <h2>Quests</h2>
                    <p class="quest-subtitle">Complete quests to earn stars and restore the island</p>
                </div>
                <div id="quest-list"></div>
            </div>

            <!-- Island Screen -->
            <div id="island-screen" class="screen">
                <div id="island-stats"></div>
                <div class="island-tab-bar">
                    <button class="island-tab active" data-island-tab="map">ğŸï¸ Map</button>
                    <button class="island-tab" data-island-tab="hatchery">ğŸ¥š Hatchery</button>
                </div>
                <div id="island-tab-map" class="island-tab-content active">
                    <div id="island-map-wrapper">
                        <div id="island-map"></div>
                    </div>
                </div>
                <div id="island-tab-hatchery" class="island-tab-content">
                    <div id="hatchery-container"></div>
                </div>
                <div id="island-modal" class="hidden"></div>
            </div>

            <!-- Shop Screen (Phase 3) -->
            <div id="shop-screen" class="screen">
                <div class="shop-tabs">
                    <button class="shop-tab active" data-shop-tab="shop">ğŸ›’ Shop</button>
                    <button class="shop-tab" data-shop-tab="pass">ğŸ† Pass</button>
                    <button class="shop-tab" data-shop-tab="daily">ğŸ”¥ Daily</button>
                </div>
                <div id="shop-tab-shop" class="shop-tab-content active">
                    <div id="shop-content"></div>
                </div>
                <div id="shop-tab-pass" class="shop-tab-content">
                    <div id="pass-content"></div>
                </div>
                <div id="shop-tab-daily" class="shop-tab-content">
                    <div id="daily-content"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav id="bottom-nav">
            <button class="nav-btn active" data-screen="board">
                <span class="nav-icon">â¬¡</span>
                <span class="nav-label">Board</span>
            </button>
            <button class="nav-btn" data-screen="quest">
                <span class="nav-icon">ğŸ“‹</span>
                <span class="nav-label">Quests</span>
            </button>
            <button class="nav-btn" data-screen="island">
                <span class="nav-icon">ğŸï¸</span>
                <span class="nav-label">Island</span>
            </button>
            <button class="nav-btn" data-screen="shop">
                <span class="nav-icon">ğŸ›’</span>
                <span class="nav-label">Shop</span>
            </button>
        </nav>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden">
            <div class="settings-card">
                <h2>Settings</h2>
                <div class="settings-row">
                    <span>ğŸ”Š Sound Effects</span>
                    <label class="toggle"><input type="checkbox" id="setting-sound" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="settings-row">
                    <span>ğŸ“³ Vibration</span>
                    <label class="toggle"><input type="checkbox" id="setting-vibration" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="settings-divider"></div>
                <div class="settings-stats">
                    <p>Total Merges: <span id="stat-merges">0</span></p>
                    <p>Highest Tier: <span id="stat-tier">0</span></p>
                    <p>Chain Record: <span id="stat-chain">0</span></p>
                    <p>Items Spawned: <span id="stat-spawns">0</span></p>
                    <p>Quests Completed: <span id="stat-quests">0</span></p>
                    <p>Island Restored: <span id="stat-island">0%</span></p>
                </div>
                <div class="settings-divider"></div>
                <button class="settings-reset-btn" id="settings-reset">Reset Game</button>
                <button class="settings-close-btn" id="settings-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts (order matters: dependencies first) -->
    <script src="js/items.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/celebration.js"></script>
    <script src="js/game.js"></script>
    <script src="js/powerups.js"></script>
    <script src="js/board.js"></script>
    <script src="js/orders.js"></script>
    <script src="js/combo.js"></script>
    <script src="js/quests.js"></script>
    <script src="js/island.js"></script>
    <script src="js/creatures.js"></script>
    <script src="js/hatchery.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/pass.js"></script>
    <script src="js/daily.js"></script>
    <script src="js/events.js"></script>
    <script src="js/achievements.js"></script>
    <script src="js/recipes.js"></script>
    <script src="js/welcome.js"></script>
    <script src="js/tutorial.js"></script>

    <script>
    // â”€â”€â”€ INITIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
        'use strict';

        // Init core systems
        Game.init();
        Board.init();
        PowerUps.init();
        Orders.init();
        Quests.init();
        Island.init();
        Hatchery.init();
        Creatures.initCompanions();
        Shop.init();
        Pass.init();
        Daily.init();
        Combo.init();
        Events.init();
        Achievements.init();
        Recipes.init();
        Welcome.init();

        // Init audio on first user interaction
        document.addEventListener('pointerdown', function() {
            Sound.init();
        }, { once: true });

        // â”€â”€â”€ UI BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // Energy display
        Game.on('energyChanged', function(energy) {
            document.getElementById('energy-count').textContent = energy;
            document.getElementById('energy-max').textContent = Game.getMaxEnergy();
        });

        Game.on('energyLow', function() {
            if (typeof Board !== 'undefined' && Board.showToast) {
                Board.showToast('Energy running low! Merge to keep going.', Board.TOAST_PRIORITY.NORMAL);
            }
        });

        Game.on('energyTimer', function(ms) {
            var timerEl = document.getElementById('energy-timer');
            if (ms === null || ms <= 0) {
                timerEl.classList.add('hidden');
                return;
            }
            var min = Math.floor(ms / 60000);
            var sec = Math.floor((ms % 60000) / 1000);
            timerEl.textContent = min + ':' + (sec < 10 ? '0' : '') + sec;
            timerEl.classList.remove('hidden');
        });

        // Gems display
        Game.on('gemsChanged', function(gems) {
            document.getElementById('gems-count').textContent = gems;
            // Brief flash animation
            var el = document.getElementById('gems-display');
            el.style.transform = 'scale(1.1)';
            setTimeout(function() { el.style.transform = ''; }, 150);
        });

        // Board hint â€” hide after 3 spawns
        var hintSpawnCount = 0;
        Game.on('itemSpawned', function() {
            hintSpawnCount++;
            if (hintSpawnCount >= 3) {
                var hint = document.getElementById('board-hint');
                if (hint) hint.classList.add('hidden');
            }
        });

        // Stars display (top bar + panels)
        Game.on('starsChanged', function(stars) {
            document.getElementById('stars-count').textContent = stars;
            // Brief flash animation
            var starsEl = document.getElementById('stars-display');
            starsEl.style.transform = 'scale(1.1)';
            setTimeout(function() { starsEl.style.transform = ''; }, 150);
            // Re-render quest and island panels when stars change
            Quests.renderQuestPanel();
            Island.renderIslandMap();
        });

        // Set initial values
        document.getElementById('energy-count').textContent = Game.getEnergy();
        document.getElementById('energy-max').textContent = Game.getMaxEnergy();
        document.getElementById('gems-count').textContent = Game.getGems();
        document.getElementById('stars-count').textContent = Game.getStars();

        // â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        var navBtns = document.querySelectorAll('.nav-btn');
        for (var i = 0; i < navBtns.length; i++) {
            navBtns[i].addEventListener('click', function() {
                var screenName = this.dataset.screen;

                // Update active nav button
                for (var j = 0; j < navBtns.length; j++) {
                    navBtns[j].classList.remove('active');
                }
                this.classList.add('active');

                // Switch screen
                var screens = document.querySelectorAll('.screen');
                for (var k = 0; k < screens.length; k++) {
                    screens[k].classList.remove('active');
                }
                var target = document.getElementById(screenName + '-screen');
                if (target) target.classList.add('active');

                Sound.playNavSwitch();
            });
        }

        // â”€â”€â”€ TUTORIAL / FIRST PLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        Tutorial.start();

        // â”€â”€â”€ EXIT HOOK (return retention) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Game.initExitHook();

        // â”€â”€â”€ SHOP TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var shopTabs = document.querySelectorAll('.shop-tab');
        for (var st = 0; st < shopTabs.length; st++) {
            shopTabs[st].addEventListener('click', function() {
                var tabName = this.dataset.shopTab;
                for (var j = 0; j < shopTabs.length; j++) shopTabs[j].classList.remove('active');
                this.classList.add('active');
                document.querySelectorAll('.shop-tab-content').forEach(function(c) { c.classList.remove('active'); });
                var target = document.getElementById('shop-tab-' + tabName);
                if (target) target.classList.add('active');
                Sound.playNavSwitch();

                // Re-render active tab content
                if (tabName === 'shop') Shop.renderShop();
                if (tabName === 'pass') Pass.renderPass();
                if (tabName === 'daily') Daily.renderDaily();
            });
        }

        // â”€â”€â”€ ISLAND TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var islandTabs = document.querySelectorAll('.island-tab');
        for (var it = 0; it < islandTabs.length; it++) {
            islandTabs[it].addEventListener('click', function() {
                var tabName = this.dataset.islandTab;
                for (var j = 0; j < islandTabs.length; j++) islandTabs[j].classList.remove('active');
                this.classList.add('active');
                document.querySelectorAll('.island-tab-content').forEach(function(c) { c.classList.remove('active'); });
                var target = document.getElementById('island-tab-' + tabName);
                if (target) target.classList.add('active');
                Sound.playNavSwitch();

                // Render hatchery when switching to it
                if (tabName === 'hatchery') {
                    Hatchery.renderCollection(document.getElementById('hatchery-container'));
                }
            });
        }

        // Handle shop spawn requests (from egg purchases)
        Game.on('shopSpawnRequest', function(data) {
            // Navigate to board and spawn
            for (var j = 0; j < navBtns.length; j++) navBtns[j].classList.remove('active');
            document.querySelector('[data-screen="board"]').classList.add('active');
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById('board-screen').classList.add('active');
            Board.spawnItem(data.chain);
        });

        // â”€â”€â”€ COMPANION BAR CLICKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var compSlots = document.querySelectorAll('.companion-slot');
        for (var cs = 0; cs < compSlots.length; cs++) {
            (function(slotEl) {
                slotEl.addEventListener('click', function() {
                    Creatures.showCompanionModal(slotEl.dataset.slot);
                    Sound.playTap();
                });
            })(compSlots[cs]);
        }

        // â”€â”€â”€ RANDOM IDLE BOB DELAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Give each cell a random animation delay for the idle bob
        var cells = document.querySelectorAll('.cell');
        for (var c = 0; c < cells.length; c++) {
            cells[c].style.setProperty('--bob-delay', (Math.random() * 4).toFixed(2) + 's');
        }

        // â”€â”€â”€ RESIZE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.addEventListener('resize', function() {
            Particles.resize();
        });

        // â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('settings-btn').addEventListener('click', function() {
            var modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            Sound.playTap();

            // Update stats
            var s = Game.getState().stats || {};
            document.getElementById('stat-merges').textContent = s.totalMerges || 0;
            document.getElementById('stat-tier').textContent = s.highestTier || 0;
            document.getElementById('stat-chain').textContent = s.chainRecord || 0;
            document.getElementById('stat-spawns').textContent = s.totalSpawns || 0;
            document.getElementById('stat-quests').textContent = Quests.getCompletedCount();
            document.getElementById('stat-island').textContent = Island.getRestorationPercent() + '%';

            // Set toggle states
            document.getElementById('setting-sound').checked = Sound.isEnabled();
            document.getElementById('setting-vibration').checked = Game.getState().vibrationEnabled !== false;
        });

        document.getElementById('settings-close').addEventListener('click', function() {
            document.getElementById('settings-modal').classList.add('hidden');
        });

        document.getElementById('setting-sound').addEventListener('change', function() {
            Sound.setEnabled(this.checked);
            var state = Game.getState();
            state.soundEnabled = this.checked;
            Game.save();
        });

        document.getElementById('setting-vibration').addEventListener('change', function() {
            var state = Game.getState();
            state.vibrationEnabled = this.checked;
            Game.save();
        });

        document.getElementById('settings-reset').addEventListener('click', function() {
            if (confirm('Reset all game progress? This cannot be undone!')) {
                localStorage.removeItem('haven_save');
                location.reload();
            }
        });

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });

        // Prevent pull-to-refresh and scroll interference on mobile
        // Cover the entire board screen, resource nodes, and board area
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.closest('#board-screen') || e.target.closest('#board') || e.target.closest('#resource-nodes')) {
                e.preventDefault();
            }
        }, { passive: false });

        // Prevent context menu (long-press) on entire app
        document.getElementById('app').addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

    })();
    </script>
</body>
</html>
