<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d1b2a">
    <title>Haven</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸï¸</text></svg>">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/island.css">
    <link rel="stylesheet" href="css/shop.css">
    <link rel="stylesheet" href="css/tiles.css">
    <link rel="stylesheet" href="css/tutorial.css">
    <link rel="stylesheet" href="css/recipes.css">
    <link rel="stylesheet" href="css/welcome.css">
    <link rel="stylesheet" href="css/combo.css">
    <link rel="stylesheet" href="css/daily.css">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="css/achievements.css">
    <link rel="stylesheet" href="css/celebration.css">
    <link rel="stylesheet" href="css/ad-adapter.css">
</head>
<body>
    <div id="app">
        <!-- Top Bar -->
        <header id="top-bar">
            <div id="energy-display">
                <span class="energy-icon">âš¡</span>
                <span id="energy-count">100</span>/<span id="energy-max">100</span>
                <span id="energy-timer" class="hidden"></span>
            </div>
            <h1 id="game-title">Haven</h1>
            <div style="display:flex;align-items:center;gap:6px;">
                <div id="stars-display">
                    <span class="stars-icon">â­</span>
                    <span id="stars-count">0</span>
                </div>
                <div id="gems-display">
                    <span class="gems-icon">ğŸ’</span>
                    <span id="gems-count">50</span>
                </div>
                <button id="achievements-btn" title="Achievements">ğŸ†<span id="achievements-badge" class="hidden">0</span></button>
                <button id="settings-btn" class="settings-gear" title="Settings">âš™ï¸</button>
            </div>
        </header>

        <!-- Screens -->
        <main id="screens">
            <!-- Board Screen -->
            <div id="board-screen" class="screen active">
                <div id="board-hint" class="board-hint">
                    ğŸ‘‡ Tap a resource button below to spawn items, then drag matching items together to merge!
                </div>
                <div id="surge-bar" class="hidden">
                    <div id="surge-fill"></div>
                    <span id="surge-label"></span>
                </div>
                <div id="piggy-surge-indicator" class="hidden">ğŸ· <span id="piggy-surge-count">0</span> ğŸ’</div>
                <div id="board-toolbar">
                    <button id="collection-counter-btn" class="collection-counter-btn" title="Collection">
                        ğŸ“‹ <span id="collection-counter" class="hidden">0</span>
                    </button>
                    <div id="powerup-bar"></div>
                    <button id="recipe-book-btn" class="recipe-book-btn hidden" title="Recipe Book">ğŸ“–</button>
                </div>
                <div id="orders-panel"></div>
                <div id="focus-bar" class="focus-bar hidden">
                    <span id="focus-icon" class="focus-icon"></span>
                    <span id="focus-desc" class="focus-desc"></span>
                    <div class="focus-progress-wrap">
                        <div id="focus-progress" class="focus-progress-fill"></div>
                    </div>
                    <span id="focus-count" class="focus-count"></span>
                    <button id="focus-clear" class="focus-clear-btn" title="Unpin">&times;</button>
                </div>
                <div id="board-wrapper">
                    <div id="board-container">
                        <canvas id="particle-canvas"></canvas>
                        <div id="board"></div>
                    </div>
                </div>

                <!-- Companion Bar (2 slots, between board and resource nodes) -->
                <div id="companion-bar" style="display:none;">
                    <div class="companion-slot empty" data-slot="slot1"><span class="companion-plus">+</span></div>
                    <div class="companion-slot empty" data-slot="slot2"><span class="companion-plus">+</span></div>
                </div>

                <!-- Resource Nodes -->
                <div id="resource-nodes">
                    <button class="node" data-chain="wood">
                        <span class="node-icon">ğŸŒ²</span>
                        <span class="node-label">Wood</span>
                    </button>
                    <button class="node" data-chain="stone">
                        <span class="node-icon">â›°ï¸</span>
                        <span class="node-label">Stone</span>
                    </button>
                    <button class="node" data-chain="flora">
                        <span class="node-icon">ğŸŒ¸</span>
                        <span class="node-label">Flora</span>
                    </button>
                    <button class="node" data-chain="crystal">
                        <span class="node-icon">ğŸ’</span>
                        <span class="node-label">Crystal</span>
                    </button>
                    <button class="node" data-chain="creature">
                        <span class="node-icon">ğŸ¥š</span>
                        <span class="node-label">Egg</span>
                    </button>
                </div>
            </div>

            <!-- Quest Screen -->
            <div id="quest-screen" class="screen">
                <div class="quest-header-bar">
                    <h2>Quests</h2>
                    <p class="quest-subtitle">Complete quests to earn stars and restore the island</p>
                </div>
                <div id="quest-list"></div>
            </div>

            <!-- Island Screen -->
            <div id="island-screen" class="screen">
                <div id="island-stats"></div>
                <div class="island-tab-bar">
                    <button class="island-tab active" data-island-tab="map">ğŸï¸ Map</button>
                    <button class="island-tab" data-island-tab="hatchery">ğŸ¥š Hatchery</button>
                </div>
                <div id="island-tab-map" class="island-tab-content active">
                    <div id="island-map-wrapper">
                        <div id="island-map"></div>
                    </div>
                </div>
                <div id="island-tab-hatchery" class="island-tab-content">
                    <div id="hatchery-container"></div>
                </div>
                <div id="island-modal" class="hidden"></div>
            </div>

            <!-- Shop Screen (Phase 3) -->
            <div id="shop-screen" class="screen">
                <div class="shop-tabs">
                    <button class="shop-tab active" data-shop-tab="shop">ğŸ›’ Shop</button>
                    <button class="shop-tab" data-shop-tab="pass">ğŸ† Pass</button>
                    <button class="shop-tab" data-shop-tab="daily">ğŸ”¥ Daily</button>
                </div>
                <div id="shop-tab-shop" class="shop-tab-content active">
                    <div id="shop-content"></div>
                </div>
                <div id="shop-tab-pass" class="shop-tab-content">
                    <div id="pass-content"></div>
                </div>
                <div id="shop-tab-daily" class="shop-tab-content">
                    <div id="daily-content"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav id="bottom-nav">
            <button class="nav-btn active" data-screen="board">
                <span class="nav-icon">â¬¡</span>
                <span class="nav-label">Board</span>
            </button>
            <button class="nav-btn" data-screen="quest">
                <span class="nav-icon">ğŸ“‹</span>
                <span class="nav-label">Quests</span>
            </button>
            <button class="nav-btn" data-screen="island">
                <span class="nav-icon">ğŸï¸</span>
                <span class="nav-label">Island</span>
            </button>
            <button class="nav-btn" data-screen="shop">
                <span class="nav-icon">ğŸ›’</span>
                <span class="nav-label">Shop</span>
            </button>
        </nav>

        <!-- Recipe Book Overlay -->
        <div id="recipe-book-overlay" class="hidden">
            <div class="recipe-book-card">
                <h3>ğŸ“– Recipe Book</h3>
                <p class="recipe-book-subtitle">Combine items from different chains at the same tier</p>
                <div class="recipe-list">
                    <div class="recipe-row">
                        <span class="recipe-input">ğŸŒ¸ Flora</span>
                        <span class="recipe-plus">+</span>
                        <span class="recipe-input">ğŸŒ² Wood</span>
                        <span class="recipe-arrow">â†’</span>
                        <span class="recipe-output">ğŸŒ¿ Living</span>
                    </div>
                    <div class="recipe-row">
                        <span class="recipe-input">ğŸ’ Crystal</span>
                        <span class="recipe-plus">+</span>
                        <span class="recipe-input">â›°ï¸ Stone</span>
                        <span class="recipe-arrow">â†’</span>
                        <span class="recipe-output">ğŸ”® Arcane</span>
                    </div>
                    <div class="recipe-row">
                        <span class="recipe-input">â›°ï¸ Stone</span>
                        <span class="recipe-plus">+</span>
                        <span class="recipe-input">ğŸŒ² Wood</span>
                        <span class="recipe-arrow">â†’</span>
                        <span class="recipe-output">ğŸ  Shelter</span>
                    </div>
                    <div class="recipe-row">
                        <span class="recipe-input">ğŸ’ Crystal</span>
                        <span class="recipe-plus">+</span>
                        <span class="recipe-input">ğŸŒ¸ Flora</span>
                        <span class="recipe-arrow">â†’</span>
                        <span class="recipe-output">âœ¨ Mystic</span>
                    </div>
                </div>
                <p class="recipe-book-hint">Drag one item onto another from a different chain at the same tier!</p>
                <button class="recipe-book-close-btn">Close</button>
            </div>
        </div>

        <!-- Away Earnings Overlay -->
        <div id="away-earnings-overlay" class="hidden">
            <div class="away-earnings-card">
                <h3>Welcome Back!</h3>
                <p class="away-earnings-detail">Your workers earned gems while you were away</p>
                <div class="away-earnings-gems">ğŸ’ <span id="away-earnings-amount">0</span></div>
                <button class="away-earnings-collect-btn">Collect!</button>
            </div>
        </div>

        <!-- Collection Overlay -->
        <div id="collection-overlay" class="hidden">
            <div class="collection-card">
                <h3>ğŸ† Collection</h3>
                <p class="collection-subtitle">Max-tier items you've created</p>
                <div id="collection-grid" class="collection-grid"></div>
                <button class="collection-close-btn">Close</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden">
            <div class="settings-card">
                <h2>Settings</h2>
                <div class="settings-row">
                    <span>ğŸ”Š Sound Effects</span>
                    <label class="toggle"><input type="checkbox" id="setting-sound" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="settings-row">
                    <span>ğŸµ Music</span>
                    <label class="toggle"><input type="checkbox" id="setting-music" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="settings-row">
                    <span>ğŸ“³ Vibration</span>
                    <label class="toggle"><input type="checkbox" id="setting-vibration" checked><span class="toggle-slider"></span></label>
                </div>
                <div class="settings-divider"></div>
                <div class="settings-stats">
                    <p>Total Merges: <span id="stat-merges">0</span></p>
                    <p>Highest Tier: <span id="stat-tier">0</span></p>
                    <p>Chain Record: <span id="stat-chain">0</span></p>
                    <p>Items Spawned: <span id="stat-spawns">0</span></p>
                    <p>Quests Completed: <span id="stat-quests">0</span></p>
                    <p>Island Restored: <span id="stat-island">0%</span></p>
                </div>
                <button class="share-brag-btn" id="settings-share">ğŸ“¤ Share My Stats</button>
                <div class="settings-divider"></div>
                <button class="settings-reset-btn" id="settings-reset">Reset Game</button>
                <button class="settings-close-btn" id="settings-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts (order matters: dependencies first) -->
    <script src="js/performance.js"></script>
    <script src="js/items.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/celebration.js"></script>
    <script src="js/game.js"></script>
    <script src="js/ad-adapter.js"></script>
    <script src="js/powerups.js"></script>
    <script src="js/board.js"></script>
    <script src="js/orders.js"></script>
    <script src="js/combo.js"></script>
    <script src="js/quests.js"></script>
    <script src="js/island.js"></script>
    <script src="js/creatures.js"></script>
    <script src="js/hatchery.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/pass.js"></script>
    <script src="js/daily.js"></script>
    <script src="js/events.js"></script>
    <script src="js/achievements.js"></script>
    <script src="js/recipes.js"></script>
    <script src="js/share.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/welcome.js"></script>
    <script src="js/tutorial.js"></script>

    <script>
    // â”€â”€â”€ INITIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
        'use strict';

        // Detect device performance tier and apply CSS classes
        Performance.init();

        // Init core systems
        Game.init();
        Board.init();
        PowerUps.init();
        Orders.init();
        Quests.init();
        Island.init();
        Hatchery.init();
        Creatures.initCompanions();
        Shop.init();
        AdAdapter.init();
        Pass.init();
        Daily.init();
        Combo.init();
        Events.init();
        Achievements.init();
        Recipes.init();
        Notifications.init();
        Welcome.init();

        // Init audio on first user interaction
        document.addEventListener('pointerdown', function() {
            Sound.init();
        }, { once: true });

        // â”€â”€â”€ UI BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // Energy display
        Game.on('energyChanged', function(energy) {
            document.getElementById('energy-count').textContent = energy;
            document.getElementById('energy-max').textContent = Game.getMaxEnergy();
        });

        Game.on('energyLow', function() {
            if (typeof Board !== 'undefined' && Board.showToast) {
                Board.showToast('Energy running low! Merge to keep going.', Board.TOAST_PRIORITY.NORMAL);
            }
        });

        Game.on('energyFull', function() {
            if (typeof Board !== 'undefined' && Board.showToast) {
                Board.showToast('\u26A1 Energy fully recharged!', Board.TOAST_PRIORITY.NORMAL);
            }
        });

        Game.on('energyTimer', function(ms) {
            var timerEl = document.getElementById('energy-timer');
            if (ms === null || ms <= 0) {
                timerEl.classList.add('hidden');
                return;
            }
            var min = Math.floor(ms / 60000);
            var sec = Math.floor((ms % 60000) / 1000);
            timerEl.textContent = min + ':' + (sec < 10 ? '0' : '') + sec;
            timerEl.classList.remove('hidden');
        });

        // Gems display
        Game.on('gemsChanged', function(gems) {
            document.getElementById('gems-count').textContent = gems;
            // Brief flash animation
            var el = document.getElementById('gems-display');
            el.style.transform = 'scale(1.1)';
            setTimeout(function() { el.style.transform = ''; }, 150);
        });

        // Piggy bank surge indicator â€” show gem count during surge only
        var piggyIndicator = document.getElementById('piggy-surge-indicator');
        var piggyCount = document.getElementById('piggy-surge-count');
        Game.on('surgeActivated', function() {
            if (typeof Shop !== 'undefined') {
                piggyCount.textContent = Shop.getPiggyGems();
                piggyIndicator.classList.remove('hidden');
            }
        });
        Game.on('surgeEnded', function() {
            piggyIndicator.classList.add('hidden');
        });
        // Update piggy count during surge when gems accumulate
        Game.on('gemsChanged', function() {
            if (!piggyIndicator.classList.contains('hidden') && typeof Shop !== 'undefined') {
                piggyCount.textContent = Shop.getPiggyGems();
            }
        });

        // Board hint â€” hide once player has spawned 3+ items (persisted in save)
        (function() {
            var hint = document.getElementById('board-hint');
            var stats = Game.getState().stats || {};
            if (stats.totalSpawns >= 3) {
                if (hint) hint.classList.add('hidden');
            } else {
                Game.on('itemSpawned', function() {
                    var s = Game.getState().stats || {};
                    if (s.totalSpawns >= 3 && hint) {
                        hint.classList.add('hidden');
                    }
                });
            }
        })();

        // Stars display (top bar + panels)
        Game.on('starsChanged', function(stars) {
            document.getElementById('stars-count').textContent = stars;
            // Brief flash animation
            var starsEl = document.getElementById('stars-display');
            starsEl.style.transform = 'scale(1.1)';
            setTimeout(function() { starsEl.style.transform = ''; }, 150);
            // Re-render quest and island panels when stars change
            Quests.renderQuestPanel();
            Island.renderIslandMap();
        });

        // Set initial values
        document.getElementById('energy-count').textContent = Game.getEnergy();
        document.getElementById('energy-max').textContent = Game.getMaxEnergy();
        document.getElementById('gems-count').textContent = Game.getGems();
        document.getElementById('stars-count').textContent = Game.getStars();

        // â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        var navBtns = document.querySelectorAll('.nav-btn');
        for (var i = 0; i < navBtns.length; i++) {
            navBtns[i].addEventListener('click', function() {
                var screenName = this.dataset.screen;

                // Update active nav button
                for (var j = 0; j < navBtns.length; j++) {
                    navBtns[j].classList.remove('active');
                }
                this.classList.add('active');

                // Switch screen
                var screens = document.querySelectorAll('.screen');
                for (var k = 0; k < screens.length; k++) {
                    screens[k].classList.remove('active');
                }
                var target = document.getElementById(screenName + '-screen');
                if (target) target.classList.add('active');

                Sound.playNavSwitch();
            });
        }

        // â”€â”€â”€ TUTORIAL / FIRST PLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        Tutorial.start();

        // â”€â”€â”€ RECIPE BOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function() {
            var btn = document.getElementById('recipe-book-btn');
            var overlay = document.getElementById('recipe-book-overlay');
            if (!btn || !overlay) return;

            // Show button only after tutorial completes
            var state = Game.getState();
            if (!state.firstPlay) {
                btn.classList.remove('hidden');
            } else {
                Game.on('tutorialComplete', function() {
                    btn.classList.remove('hidden');
                });
            }

            btn.addEventListener('click', function() {
                overlay.classList.remove('hidden');
                Sound.playTap();
            });

            overlay.querySelector('.recipe-book-close-btn').addEventListener('click', function() {
                overlay.classList.add('hidden');
            });

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) overlay.classList.add('hidden');
            });
        })();

        // â”€â”€â”€ AWAY EARNINGS OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function() {
            var overlay = document.getElementById('away-earnings-overlay');
            if (!overlay) return;

            // Check if there are pending away earnings
            setTimeout(function() {
                var earnings = window._havenAwayEarnings || 0;
                if (earnings > 0) {
                    document.getElementById('away-earnings-amount').textContent = earnings;
                    overlay.classList.remove('hidden');
                }
            }, 800);

            overlay.querySelector('.away-earnings-collect-btn').addEventListener('click', function() {
                overlay.classList.add('hidden');
                Sound.playCelebration();
                Game.vibrate([15, 30, 15]);
                window._havenAwayEarnings = 0;
            });

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                    window._havenAwayEarnings = 0;
                }
            });
        })();

        // â”€â”€â”€ COLLECTION OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function() {
            var btn = document.getElementById('collection-counter-btn');
            var overlay = document.getElementById('collection-overlay');
            if (!btn || !overlay) return;

            btn.addEventListener('click', function() {
                var collection = Game.getCollection();
                var gridEl = document.getElementById('collection-grid');
                if (!gridEl) return;

                gridEl.innerHTML = '';

                if (collection.length === 0) {
                    gridEl.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;font-size:13px;">No max-tier items yet. Keep merging!</p>';
                } else {
                    // Group by chain
                    var byChain = {};
                    for (var i = 0; i < collection.length; i++) {
                        var c = collection[i];
                        if (!byChain[c.chain]) byChain[c.chain] = { count: 0, tier: c.tier };
                        byChain[c.chain].count++;
                    }

                    var chains = Object.keys(byChain);
                    for (var j = 0; j < chains.length; j++) {
                        var chainKey = chains[j];
                        var data = byChain[chainKey];
                        var chainData = Items.chains[chainKey];
                        if (!chainData) continue;

                        var tierDef = chainData.tiers[data.tier];
                        var itemEl = document.createElement('div');
                        itemEl.className = 'collection-item';
                        itemEl.innerHTML =
                            '<span class="collection-item-icon">' + (tierDef ? tierDef.symbol : chainData.icon) + '</span>' +
                            '<span class="collection-item-name">' + (tierDef ? tierDef.name : chainData.name) + '</span>' +
                            '<span class="collection-item-count">x' + data.count + '</span>';
                        gridEl.appendChild(itemEl);
                    }
                }

                overlay.classList.remove('hidden');
                Sound.playTap();
            });

            overlay.querySelector('.collection-close-btn').addEventListener('click', function() {
                overlay.classList.add('hidden');
            });

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) overlay.classList.add('hidden');
            });
        })();

        // â”€â”€â”€ FOCUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function() {
            var focusBar = document.getElementById('focus-bar');
            var focusIcon = document.getElementById('focus-icon');
            var focusDesc = document.getElementById('focus-desc');
            var focusProgress = document.getElementById('focus-progress');
            var focusCount = document.getElementById('focus-count');
            var focusClear = document.getElementById('focus-clear');
            if (!focusBar) return;

            function updateFocusBar() {
                var goal = Game.getFocusedGoal();
                if (!goal) {
                    focusBar.classList.add('hidden');
                    return;
                }

                if (goal.type === 'order' && typeof Orders !== 'undefined') {
                    // Find the order by ID
                    var state = Game.getState();
                    var orderState = state.orders;
                    if (!orderState || !orderState.active) { focusBar.classList.add('hidden'); return; }

                    var order = null;
                    for (var i = 0; i < orderState.active.length; i++) {
                        if (orderState.active[i].id === goal.id) {
                            order = orderState.active[i];
                            break;
                        }
                    }

                    if (!order || order.completed || order.claimed) {
                        // Goal completed or gone
                        Game.clearFocusedGoal();
                        focusBar.classList.add('hidden');
                        return;
                    }

                    // Calculate progress
                    var totalNeeded = 0;
                    var totalDelivered = 0;
                    var reqDescs = [];
                    for (var r = 0; r < order.requirements.length; r++) {
                        var req = order.requirements[r];
                        totalNeeded += req.count;
                        totalDelivered += req.delivered;
                        var chainData = Items.chains[req.chain];
                        var tierDef = chainData ? chainData.tiers[req.tier] : null;
                        reqDescs.push((tierDef ? tierDef.name : 'T' + req.tier));
                    }

                    var chainData = Items.chains[order.primaryChain];
                    focusIcon.textContent = chainData ? chainData.icon : '\uD83D\uDCE6';
                    focusDesc.textContent = reqDescs.join(', ');
                    focusProgress.style.width = (totalNeeded > 0 ? (totalDelivered / totalNeeded * 100) : 0) + '%';
                    focusCount.textContent = totalDelivered + '/' + totalNeeded;
                    focusBar.classList.remove('hidden');
                } else {
                    focusBar.classList.add('hidden');
                }
            }

            Game.on('focusChanged', updateFocusBar);
            Game.on('orderCompleted', function(data) {
                var goal = Game.getFocusedGoal();
                if (goal && goal.type === 'order' && goal.id === data.orderId) {
                    Game.clearFocusedGoal();
                }
            });

            // Update focus bar when orders change
            var origInterval = setInterval(updateFocusBar, 2000);

            focusClear.addEventListener('click', function() {
                Game.clearFocusedGoal();
                Sound.playTap();
            });

            // Initial render
            setTimeout(updateFocusBar, 600);
        })();

        // â”€â”€â”€ EXIT HOOK (return retention) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Game.initExitHook();

        // â”€â”€â”€ SHOP TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var shopTabs = document.querySelectorAll('.shop-tab');
        for (var st = 0; st < shopTabs.length; st++) {
            shopTabs[st].addEventListener('click', function() {
                var tabName = this.dataset.shopTab;
                for (var j = 0; j < shopTabs.length; j++) shopTabs[j].classList.remove('active');
                this.classList.add('active');
                document.querySelectorAll('.shop-tab-content').forEach(function(c) { c.classList.remove('active'); });
                var target = document.getElementById('shop-tab-' + tabName);
                if (target) target.classList.add('active');
                Sound.playNavSwitch();

                // Re-render active tab content
                if (tabName === 'shop') Shop.renderShop();
                if (tabName === 'pass') Pass.renderPass();
                if (tabName === 'daily') Daily.renderDaily();
            });
        }

        // â”€â”€â”€ ISLAND TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var islandTabs = document.querySelectorAll('.island-tab');
        for (var it = 0; it < islandTabs.length; it++) {
            islandTabs[it].addEventListener('click', function() {
                var tabName = this.dataset.islandTab;
                for (var j = 0; j < islandTabs.length; j++) islandTabs[j].classList.remove('active');
                this.classList.add('active');
                document.querySelectorAll('.island-tab-content').forEach(function(c) { c.classList.remove('active'); });
                var target = document.getElementById('island-tab-' + tabName);
                if (target) target.classList.add('active');
                Sound.playNavSwitch();

                // Render hatchery when switching to it
                if (tabName === 'hatchery') {
                    Hatchery.renderCollection(document.getElementById('hatchery-container'));
                    Hatchery.clearNewBadge();
                }
            });
        }

        // Handle shop spawn requests (from egg purchases)
        Game.on('shopSpawnRequest', function(data) {
            // Navigate to board and spawn
            for (var j = 0; j < navBtns.length; j++) navBtns[j].classList.remove('active');
            document.querySelector('[data-screen="board"]').classList.add('active');
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById('board-screen').classList.add('active');
            Board.spawnItem(data.chain);
        });

        // â”€â”€â”€ COMPANION BAR CLICKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var compSlots = document.querySelectorAll('.companion-slot');
        for (var cs = 0; cs < compSlots.length; cs++) {
            (function(slotEl) {
                slotEl.addEventListener('click', function() {
                    Creatures.showCompanionModal(slotEl.dataset.slot);
                    Sound.playTap();
                });
            })(compSlots[cs]);
        }

        // â”€â”€â”€ RANDOM IDLE BOB DELAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Give each cell a random animation delay for the idle bob
        var cells = document.querySelectorAll('.cell');
        for (var c = 0; c < cells.length; c++) {
            cells[c].style.setProperty('--bob-delay', (Math.random() * 4).toFixed(2) + 's');
        }

        // â”€â”€â”€ RESIZE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.addEventListener('resize', function() {
            Particles.resize();
        });

        // â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('settings-btn').addEventListener('click', function() {
            var modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            Sound.playTap();

            // Update stats
            var s = Game.getState().stats || {};
            document.getElementById('stat-merges').textContent = s.totalMerges || 0;
            document.getElementById('stat-tier').textContent = s.highestTier || 0;
            document.getElementById('stat-chain').textContent = s.chainRecord || 0;
            document.getElementById('stat-spawns').textContent = s.totalSpawns || 0;
            document.getElementById('stat-quests').textContent = Quests.getCompletedCount();
            document.getElementById('stat-island').textContent = Island.getRestorationPercent() + '%';

            // Set toggle states
            document.getElementById('setting-sound').checked = Sound.isEnabled();
            document.getElementById('setting-music').checked = Sound.isMusicEnabled();
            document.getElementById('setting-vibration').checked = Game.getState().vibrationEnabled !== false;
        });

        document.getElementById('settings-close').addEventListener('click', function() {
            document.getElementById('settings-modal').classList.add('hidden');
        });

        document.getElementById('setting-sound').addEventListener('change', function() {
            Sound.setEnabled(this.checked);
            var state = Game.getState();
            state.soundEnabled = this.checked;
            Game.save();
        });

        document.getElementById('setting-music').addEventListener('change', function() {
            Sound.setMusicEnabled(this.checked);
            var state = Game.getState();
            state.musicEnabled = this.checked;
            Game.save();
        });

        document.getElementById('setting-vibration').addEventListener('change', function() {
            var state = Game.getState();
            state.vibrationEnabled = this.checked;
            Game.save();
        });

        document.getElementById('settings-share').addEventListener('click', function() {
            if (typeof Share !== 'undefined') Share.shareBragCard('stats');
        });

        document.getElementById('settings-reset').addEventListener('click', function() {
            if (confirm('Reset all game progress? This cannot be undone!')) {
                localStorage.removeItem('haven_save');
                location.reload();
            }
        });

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });

        // Prevent pull-to-refresh and scroll interference on mobile
        // Cover the entire board screen, resource nodes, and board area
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.closest('#board-screen') || e.target.closest('#board') || e.target.closest('#resource-nodes')) {
                e.preventDefault();
            }
        }, { passive: false });

        // Prevent context menu (long-press) on entire app
        document.getElementById('app').addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

    })();
    </script>
</body>
</html>
