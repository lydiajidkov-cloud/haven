2026-02-12 â€” Task 1: Fix 3 critical bugs
  (a) Audio clipping: DynamicsCompressorNode was already in place in js/audio.js (lines 15-26).
      Compressor chain: oscillators â†’ compressor (threshold -12dB, ratio 8:1) â†’ masterGain (0.85) â†’ destination.
      No change needed â€” verified working.
  (b) Worker/companion mutual exclusion: Added guard in assignWorker() (js/island.js:531) to reject
      creatures that are currently companions. Added reverse guard in equipCompanion() (js/creatures.js:369)
      to reject creatures that are currently workers. Both UI modals already filtered correctly; these
      guards protect the function-level API from bypasses.
  (c) double_reward companion ability: Fixed max-tier merge path (js/board.js:812) which previously
      gave hardcoded 10 gems without checking/consuming the double_reward flag. Now applies 2x multiplier
      and shows "2x COMPANION!" floating text. The flag already correctly persists past tier 1-2 merges
      (those merges don't enter the gem-reward block and don't consume the flag).

2026-02-12 â€” Task 2: Wire event modifiers into gameplay
  All 8 event modifier types are now read by gameplay code at their respective insertion points.
  Previously, Events module defined modifiers but no other module queried them â€” they were dead code.

  Files modified: js/board.js, js/game.js, js/hatchery.js

  Insertion point 1 â€” Gem rewards (board.js):
    - gem_multiplier: Applied to both regular merge gems (tier 3+) and max-tier merge gems.
      Chain-specific: only activates for the matching chain (e.g., Crystal Rush â†’ crystal merges only).
    - crosschain_reward_multiplier: Added base gem reward for cross-chain merges (tier-scaled),
      then multiplied by event value (e.g., Chain Master 3x).

  Insertion point 2 â€” Item spawning (board.js + hatchery.js):
    - spawn_tier_boost: After normal spawn tier calculation (including creature spawn quality bonus),
      adds the event boost value to the spawn tier, capped at max tier. Chain-specific.
    - discovery_boost: Applied in hatchery.js onItemProduced() â€” multiplies creature discovery
      chance by event value (e.g., Discovery Week 2x). Applied after creature passive bonuses.

  Insertion point 3 â€” Merge count thresholds (board.js):
    - min_merge_override: Replaced all 10 usages of the MIN_MERGE constant with getEffectiveMinMerge()
      which queries Events for an active min_merge_override. Affects: attemptMerge, swipe-merge,
      chain reactions, auto-merges, mass match, shuffle scan, companion pair finding.
      Makes Merge Mania ("All merges need only 2 items!") functional.

  Insertion point 4 â€” Energy regeneration (game.js):
    - energy_regen_multiplier: Divides regen interval by event value (e.g., Speed Demon halves
      the time). Applied after creature passive energy regen bonus. Floor of 30s minimum.

  Additional insertion points:
    - surge_boost: feedSurge() now accepts a chain parameter. When Stone Surge is active,
      surge gain is multiplied by event value for matching chain merges.
    - chain_reaction_boost: checkChainReaction() now gives a 50% bonus roll when connected
      items are 1 below the merge threshold during an active chain_reaction_boost event for
      the matching chain. This makes chain reactions "2x more likely" for Flora Festival.

  All event queries use typeof guards (typeof Events !== 'undefined') for safety.
  Events.hasModifier(type, chain) and Events.getModifierValue(type, chain) are the query API.

2026-02-12 â€” Task 3: Harden save system
  All 5 requirements implemented in js/game.js. No other files modified â€” the public API
  (Game.save()) is unchanged so all 21 external call sites work without modification.

  Files modified: js/game.js

  (a) 200ms debounce on Game.save() with beforeunload flush:
    - save() now sets a savePending flag and starts a 200ms setTimeout. Rapid calls within
      the window are coalesced into a single write. This prevents the 3-5 writes/sec during
      fast merging that Engineering flagged (synthesis score: 2/5 for save robustness).
    - flushSave() performs the actual write immediately and clears the timer.
    - beforeunload listener registered in init() calls flushSave() to ensure no pending
      state is lost when the player closes the tab or navigates away.
    - resetGame() calls flushSave() directly (not debounced) since a full state reset
      must be written immediately.

  (b) Save format version number:
    - Added _saveVersion: 1 to defaultState() and stamped on every flushSave().
    - migrateState() function ready for future version migrations (e.g., when Task 4
      changes MIN_MERGE or Task 11 adds board expansion, save format can be migrated).
    - SAVE_VERSION constant exported as Game.SAVE_VERSION for other modules.

  (c) Backup to haven-backup key:
    - After every successful primary write to 'haven_save', the same JSON is written
      to 'haven-backup'. Backup failure is logged but doesn't block the primary save.

  (d) Try/catch with fallback to backup:
    - load() tries primary key first via loadFromKey(). If primary is missing or corrupted
      (parse error, missing board/stats), falls back to loadFromKey(BACKUP_KEY).
    - On successful backup restore, heals the primary key from backup data.
    - Both loadFromKey() and flushSave() are fully wrapped in try/catch.
    - saveFailed event emitted on write failure for future UI notification.

  (e) Quota check before save:
    - estimateLocalStorageUsage() enumerates all localStorage keys and sums their
      UTF-16 byte sizes. Called before each write in flushSave().
    - If total usage + save size exceeds 4.5MB (QUOTA_WARN_BYTES), logs a warning
      and emits saveQuotaWarning event with byte counts for future UI display.
    - Does not block the save â€” just warns. The actual QuotaExceededError from
      localStorage.setItem() is caught by the existing try/catch.

2026-02-12 â€” Task 4: Raise thresholds: merge gems + MIN_MERGE
  Two related economy tightening changes that reduce free gem income ~30% and add strategic
  tension to merging. Both were agreed in the Phase 2 compromise (sinks before source cuts).

  Files modified: js/board.js, js/game.js

  (a) Raise gem-award tier from 3 to 4 (board.js:912):
    - Changed `if (nextTier >= 3)` to `if (nextTier >= 4)` in executeMerge().
    - Rebased gem formula from `Math.pow(1.8, nextTier - 3)` to `Math.pow(1.8, nextTier - 4)`
      so tier 4 now gets the base reward (1 gem) that tier 3 used to get.
    - Tier 3 merges no longer award gems at all â€” they still get screen-shake celebration
      (line 906, unchanged) but no gem reward.
    - Max-tier merge gems (line 829) were already tier-agnostic (flat 10 gems) â€” unchanged.
    - double_reward companion ability now naturally persists through tier 3 merges (they no
      longer enter the gem block, so the flag isn't consumed until a tier 4+ merge awards gems).
    - Event gem_multiplier still applies to the new tier 4+ rewards â€” no change needed.

  (b) Raise MIN_MERGE from 2 to 3 (board.js:7):
    - Changed `var MIN_MERGE = 2` to `var MIN_MERGE = 3`.
    - Players must now merge 3+ matching items instead of 2. This eliminates the trivial
      "pair merge" that removed strategic tension (flagged in PRD).
    - The Merge Mania event (min_merge_override: 2) now becomes a meaningful bonus â€” during
      the event, players CAN merge pairs again, which was previously a no-op.
    - All 10 usages of MIN_MERGE already go through getEffectiveMinMerge() (from Task 2),
      so the event override system works correctly with the new base value.
    - Affects: attemptMerge, swipe-merge, chain reactions, auto-merges, mass match,
      shuffle scan, companion pair finding, lucky auto-merge, near-miss highlighting.

  (c) Save version bump (game.js):
    - SAVE_VERSION raised from 1 to 2.
    - migrateState() updated: v1 saves are stamped to v2 on load. No data migration
      needed â€” these are gameplay rule changes, not save format changes.
    - defaultState() will now stamp new saves as v2.

2026-02-12 â€” Task 5: Celebration overlay system
  Built a shared, configurable full-screen celebration overlay and brief banner system.
  One module (js/celebration.js) with a data-driven config structure serves all trigger types.

  Files created: js/celebration.js, css/celebration.css
  Files modified: index.html, js/board.js, js/hatchery.js, js/pass.js, js/events.js, js/recipes.js

  Architecture:
    - Celebration IIFE module with CONFIGS data structure mapping 7 trigger types to display settings.
    - Two display modes: 'overlay' (full-screen, z-index 80) and 'banner' (brief top pill, z-index 75).
    - All overlays are tap-skippable and auto-dismiss (3s for overlays, 1.5s for banners).
    - Each config specifies: type, title, subtitle, icon, gradient colors, sound, duration, showShare.
    - Title/subtitle/icon/gradient can be static values or functions of the trigger data.

  Trigger types wired:
    (a) maxTierMerge (overlay): Fires in board.js executeMerge() when isMaxTier is true.
        Shows chain name + "chain mastered!" with item symbol emoji.
    (b) highTierMerge (overlay): Fires in board.js executeMerge() for tier 7+ regular merges.
        Shows "TIER 7!" with item symbol and chain name.
    (c) midTierMerge (banner): Fires in board.js executeMerge() for tier 5-6 merges.
        Brief top banner instead of full-screen (fires too frequently during surge).
        Enhanced particle burst (legendary) already existed; banner adds visual text feedback.
    (d) creatureDiscovery (overlay): Fires in hatchery.js showDiscoveryModal().
        Shows creature emoji, name, rarity. Includes Web Share API share button.
        Falls back to clipboard copy on devices without Web Share API.
        Existing detailed creature modal remains underneath for discovery count + biome info.
    (e) hybridUnlock (overlay): Fires in recipes.js showDiscoveryAnimation().
        Replaces the old hand-built recipe discovery overlay with the shared celebration system.
        Keeps the recipe book button pulse effect.
    (f) battlePassTier (overlay): Fires in pass.js claimTierReward().
        Shows reward-type emoji (gems/energy/stars/egg/powerup).
    (g) eventTier (overlay): Fires in events.js claimTier().
        Shows tier label (Bronze/Silver/Gold) + event name + event icon.

  Share button (creature discovery only):
    - Uses navigator.share() (Web Share API) if available.
    - Falls back to navigator.clipboard.writeText() with toast confirmation.
    - Shares: "I just discovered [name] in Haven! [emoji] #HavenGame"

  CSS (celebration.css):
    - Full overlay: dark backdrop, centered card with shimmer effect, icon bounce animation,
      gradient title, tap-hint text. Smooth scale+fade transitions for enter/exit.
    - Brief banner: absolute positioned pill at top, gradient background, slide-down entrance.
    - Respects prefers-reduced-motion media query.

  Safety:
    - All trigger sites use typeof Celebration !== 'undefined' guards.
    - When Celebration is unavailable, falls back to existing Sound/vibrate calls.
    - celebration.js loads after particles.js (for Particles.emit access at call time)
      and before game.js. No load-time dependencies on other modules.

2026-02-12 â€” Task 6: Item discovery rewards
  Award gems for every NEW item tier a player discovers for the first time. Creates constant
  micro-dopamine hits throughout early and mid-game (competitive gap: Travel Town's most
  addictive feature).

  Files modified: js/board.js, js/audio.js, js/game.js

  Gem rewards by rarity bracket (PRD spec):
    - Common (tiers 0-2): 5 gems
    - Uncommon (tiers 3-4): 10 gems
    - Rare (tiers 5-6): 25 gems
    - Legendary (tiers 7+): 50 gems
    (Previous implementation awarded only 1/2/3 gems â€” far too low for dopamine hit)

  Distinct chime sound (audio.js):
    - Added playItemDiscovery(): bright ascending C6-E6-G6 triad with sparkle shimmer.
    - Shorter and lighter than playCreatureDiscover() â€” appropriate for frequent micro-rewards.
    - Exported from Sound module, called via typeof guard for safety.

  Floating text:
    - Shows "+X NEW!" at the cell where the item was produced (not generic board center).
    - Toast shows "New Discovery: [Item Name] ([Chain]) +X gems" with magnifying glass icon.

  Discovery tracking (save state):
    - discoveredItems{} added to Game.defaultState() for new saves.
    - Existing saves get discoveredItems initialized lazily (null-guard in checkItemDiscovery).
    - Key format: "chain_tier" â†’ timestamp. Persists across sessions.
    - itemsDiscovered stat tracked for future achievement integration.

  All item production paths now trigger discovery check:
    - Regular merge result (executeMerge â†’ checkItemDiscovery)
    - Max-tier merge (executeMerge isMaxTier path â€” previously returned early before check)
    - Cross-chain merge result (executeCrossChainMerge)
    - Upgrade Wand power-up (upgradeItem)
    - Companion free_spawn effect (executeCompanionEffect)
    - Resource node spawns (spawnItem)
    - Starter items (spawnStarterItems â€” first-play tutorial items)
    Discovery only fires once per chain+tier combo; duplicate calls are no-ops.

2026-02-12 â€” Task 7: Toast queue with cooldown + surge tooltip
  Replaced the simple fire-and-forget showToast() with a priority-based queue system
  that prevents post-tutorial toast fatigue, and added a contextual surge tooltip.

  Files modified: js/board.js, js/celebration.js, index.html

  (a) Toast queue with priority ranking and cooldown:
    - Four priority levels: CRITICAL (100), HIGH (80), NORMAL (50), LOW (20).
    - CRITICAL and HIGH bypass all cooldowns â€” show immediately (surge activation,
      board full, no merges, lucky merge, surge end).
    - NORMAL respects a 45-second cooldown between toasts. If cooldown hasn't elapsed,
      the toast is queued (max 3 items). When queue is full, lowest priority is dropped.
      Queued toasts drain automatically when cooldown expires, highest priority first.
    - LOW (for future recipe hints) requires 90 seconds of complete toast silence before
      showing. Silently dropped if the quiet period hasn't elapsed.
    - Queue drain is scheduled via setTimeout â€” no polling.
    - displayToast() properly tracks the current toast element and dismiss timer to
      prevent orphaned DOM elements when a new toast replaces an existing one.

  Priority assignments for all 10 internal toast call sites:
    - CRITICAL: board full, no merges possible (free shuffle), surge tooltip
    - HIGH: surge activated, surge ended, lucky auto-merge
    - NORMAL: cluttered board, no energy (available merges), companion effect,
      item discovery, energy low (from index.html), clipboard copy (from celebration.js)

  (b) Contextual surge tooltip â€” first surge after tutorial:
    - On first surge activation after tutorial completion (state.firstPlay === false
      and state.surgeTooltipShown !== true), shows educational tooltip:
      "ðŸ’¡ You triggered SURGE! Merge fast to keep it going!"
    - Fires 2.2 seconds after surge toast so the SURGE MODE! toast is seen first.
    - Sets state.surgeTooltipShown = true and saves, so it never fires again.
    - Uses CRITICAL priority to bypass cooldown (it's a one-time educational moment).
    - state.surgeTooltipShown is lazily initialized (undefined â†’ falsy for new saves,
      true for saves after first surge). No defaultState() change needed.

  (c) Exported showToast and TOAST_PRIORITY from Board module:
    - Board.showToast(msg, priority) now available to external callers.
    - Board.TOAST_PRIORITY exposes priority constants (CRITICAL/HIGH/NORMAL/LOW).
    - index.html and celebration.js updated to pass priority parameter.
    - Previously these callers used Board.showToast but it wasn't exported â€”
      the typeof guard made them silently fail. Now they work correctly.

2026-02-12 â€” Task 8: Tutorial improvements
  Three additions to the tutorial and post-tutorial flow that improve onboarding and
  surface a critical currency (stars) on the main board screen.

  Files modified: js/tutorial.js, index.html, css/style.css

  (a) Swipe-merge tutorial step (tutorial.js):
    - Added new 'swipe-merge' step after 'first-merge' in the STEPS array.
    - Instruction: "Now try swiping! Drag your finger across 3+ matching items to
      merge them all at once." â€” teaches the game's most satisfying input method.
    - setupSwipeMerge() function: sets forcedSpawnTier(0) to spawn tier-0 wood items,
      suppresses auto-merge so the player can practice swiping manually, and spawns
      3 wood items via Board.spawnItem('wood') to create adjacent swipe opportunities.
    - Step advances on 'mergeCompleted' event (same as first-merge step).
    - Board spotlight targets the board-wrapper so the full grid is interactive.

  (b) Cross-chain recipe hint tooltip (tutorial.js):
    - Just-in-time guidance that fires when a player first has recipe ingredients
      adjacent on the board (e.g., wood tier 1 next to flora tier 1).
    - startRecipeHintListener() registers on 'mergeCompleted' and 'itemSpawned' events.
    - checkForAdjacentRecipe() scans all board cells and their 4 orthogonal neighbors,
      calling Items.getCrossChainResult() on each pair. If an undiscovered recipe pair
      is found, shows a toast via Board.showToast() with LOW priority (respects 90s
      silence requirement from Task 7's toast queue system).
    - Toast message: "[icon] + [icon] Drag one onto the other to discover a new recipe!"
    - state.recipeHintShown flag persisted to save state â€” hint fires only once ever.
    - Listener starts both for new players (after tutorial completes, in
      showPostTutorialBreadcrumbs) and for existing players (in start() when
      firstPlay is false and recipeHintShown is falsy).

  (c) Stars display in top bar (index.html + css/style.css):
    - Added #stars-display element to the top bar, placed before #gems-display in
      the right-side flex container. Shows star emoji + count.
    - CSS: shares styling with #energy-display and #gems-display (pill shape,
      dark background, rounded borders). Color: var(--accent-gold). Min-width: 50px.
    - Event listener: 'starsChanged' updates #stars-count text and plays brief
      scale(1.1) flash animation (same pattern as gems display).
    - Initial value set from Game.getStars() during initialization.
    - Stars are now visible on the main board screen at all times â€” previously only
      visible in Island/Quest tabs. This was flagged as a critical gap: stars are
      the primary progression currency but were invisible during core gameplay.

2026-02-12 â€” Task 9: Surge system improvements
  Three improvements to the surge system that make it more visible, more satisfying to
  activate, and create "just 3 more merges to hit the next milestone" compulsion.

  Files modified: js/board.js, js/audio.js, css/style.css

  (a) Surge bar height increase (css/style.css):
    - Increased #surge-bar height from 18px to 24px (33% larger, easier to notice during
      fast play as flagged in the PRD).
    - Updated border-radius from 9px to 12px to maintain proportional rounding.
    - Updated #surge-fill border-radius to match at 12px.
    - Increased #surge-label font-size from 10px to 11px to scale with the taller bar.

  (b) Distinct surge activation sound (audio.js):
    - Added playSurgeActivate(): whoosh (filtered noise sweep) + impact thump + fast
      ascending A major power chord (A4-C#5-E5-A5) + high shimmer ring-out. Designed
      to cut through fast-merge audio and clearly signal "something special started."
    - Replaced the generic playCelebration() call in board.js activateSurge() with
      the new playSurgeActivate() sound. Falls back to playCelebration() if the new
      function isn't available (typeof guard for safety).
    - Also added playSurgeMilestone(milestone): scaling intensity sound for escalation
      milestones. 5 merges = quick double-ding, 10 merges = bright ascending chime,
      20 merges = grand triumphant burst with bass anchor.

  (c) Surge escalation milestones with scaling rewards (board.js):
    - SURGE_MILESTONES data structure defines 3 tiers:
      5 merges during surge = +10 gems
      10 merges during surge = +25 gems + 1 star
      20 merges during surge = +50 gems + rare creature egg (tier 3 creature item spawned)
    - surgeHighestMilestone variable tracks the highest milestone reached in the current
      surge, preventing duplicate rewards. Reset on surge activation and deactivation.
    - checkSurgeMilestone() called on every merge during surge. Iterates milestones
      from highest to lowest, fires the first unawarded milestone that has been reached.
    - Each milestone triggers: gem reward, optional star/egg, floating text with reward
      summary, haptic feedback, surge milestone sound, HIGH priority toast, particle burst
      (legendary particles for 20-merge, chain particles for lower milestones).
    - Rare egg (20-merge): spawns a tier-3 creature item on an empty board cell with
      legendary purple particles and spawn-in animation. Tier 3 creature items have
      a meaningful discovery chance when merged, fulfilling the "rare egg" reward.
    - Surge bar label now shows progress toward next milestone during surge:
      "SURGE 3/5", "SURGE 7/10", "SURGE 15/20". After all milestones reached,
      shows "SURGE 23âš¡" (count + lightning bolt).
    - Existing end-of-surge flat bonus (surgeMergeCount * 1.5 + 2 gems) is preserved
      as an additional reward on top of milestone rewards.

2026-02-12 â€” Task 10: Battle Pass XP visibility + extension
  Two changes that make battle pass progression visible and extend the season to ~30 days.

  Files modified: js/pass.js, css/style.css

  (a) "+X XP" floating text when merges award battle pass XP (pass.js):
    - addXP() now accepts a showFloat parameter to control visual feedback.
    - mergeCompleted and questCompleted events pass showFloat=true.
    - itemSpawned passes showFloat=false (too frequent for visual noise).
    - Throttle system: XP_FLOAT_COOLDOWN of 2 seconds between floating displays.
      Rapid XP gains accumulate into pendingXPDisplay and show as a batched
      "+X XP" when cooldown expires (e.g., "+15 XP" instead of five "+3 XP").
    - xpFlushTimer ensures accumulated XP is always shown, never silently lost.
    - showXPFloat() creates a floating-text element positioned below the gems
      display, styled in light blue (#7dd3fc) to distinguish from gold gem text.
    - Tier-up notification: when a tier is reached, shows a HIGH-priority toast
      via Board.showToast ("Haven Pass Tier X!") with trophy emoji.

  (b) Battle pass season extended from ~8-16 days to ~30 days (pass.js):
    - XP per action reduced to match 30-day target:
      mergeCompleted: 10 + tier*5 â†’ 3 + tier*2 (avg ~8 XP vs ~25 XP)
      questCompleted: 50 â†’ 25
      itemSpawned: 2 â†’ 1
    - XP-per-tier curve significantly steepened, especially for last 10 tiers:
      Tiers 1-5: 60 â†’ 150 XP (quick wins, ~1-2 days)
      Tiers 6-15: 80 â†’ 400 XP (moderate, ~5-6 days)
      Tiers 16-25: 100 â†’ 800 XP (standard, ~7-8 days)
      Tiers 26-30: 100 â†’ 1200 XP (harder, ~5-6 days)
      Tiers 31-40: 130 â†’ 2500 XP (final stretch, ~10-12 days)
    - Total XP to complete: 3,900 â†’ 43,750 (11.2x increase)
    - Combined with 3-4x XP-per-action reduction, season extends to ~30 days.
    - Last 10 tiers require 25,000 XP (57% of total), creating urgency in final
      week and the "just one more session to hit the next tier" compulsion.
    - SEASON_DURATION_MS was already 30 days (unchanged).

  CSS (style.css):
    - Added .floating-text.xp-float class: 13px font, #7dd3fc light blue color,
      visually distinct from gold gem floating text.

2026-02-12 â€” Task 11: Gem sinks: board expansion
  Purchasable board expansion: 6x8 â†’ 6x9 (500 gems) â†’ 6x10 (1000 gems) â†’ 7x10 (2000 gems).
  This is the single most important monetization lever in merge games, creating a meaningful
  gem sink that absorbs 3,500 total gems across all 3 tiers.

  Files modified: js/game.js, js/board.js, js/shop.js, css/style.css

  Architecture (game.js):
    - ROWS and COLS changed from const to var, initialized from DEFAULT_ROWS/DEFAULT_COLS (8/6).
    - On Game.init(), ROWS/COLS are loaded from save state (boardRows/boardCols fields).
    - Game.ROWS and Game.COLS exposed as Object.defineProperty getters so they always
      return the current mutable values (other modules reading Game.ROWS after expansion
      get the updated dimensions).
    - BOARD_EXPANSIONS array defines 3 tiers: {rows, cols, cost, label}.
    - getNextBoardExpansion() returns the next available expansion or null if fully expanded.
    - purchaseBoardExpansion() deducts gems, updates ROWS/COLS, expands the board array
      in state (adds rows, pads columns), saves, and emits 'boardExpanded' event.
    - SAVE_VERSION bumped from 2 to 3. migrateState() v2â†’v3 adds boardRows/boardCols
      fields to old saves and pads the board array to match.
    - resetGame() resets ROWS/COLS back to defaults.

  Board expansion UI (board.js):
    - Board.init() reads Game.ROWS/COLS and applies CSS grid dimensions via JS
      (overriding the CSS defaults), so expanded boards render correctly on reload.
    - renderExpandButton() creates a subtle dashed-border "Expand to NxM ðŸ’Ž cost" button
      below the board inside #board-wrapper. Removed when fully expanded.
    - confirmBoardExpansion() (from board button): checks gems, shows confirm() dialog,
      calls Game.purchaseBoardExpansion(), then adds new DOM cells to the grid, re-orders
      them in row-major order for CSS grid, recaches grid layout, plays purchase sound,
      and animates the new cells with a gold pop animation.
    - confirmBoardExpansionDirect() (from shop): skips the confirm dialog since the shop
      already confirmed. Navigates to board screen and executes the expansion.
    - New cells are added by padding existing rows (for column increases) and appending
      new rows (for row increases). DOM children are re-ordered to ensure CSS grid renders
      correctly after adding cells out of order.

  Shop integration (shop.js):
    - Board expansion section added to shop above "Energy & Boosts", showing the next
      available expansion with gem cost. Hidden when fully expanded.
    - purchaseBoardExpansionFromShop() navigates to board screen and emits 'shopExpandRequest'
      event, which Board handles via confirmBoardExpansionDirect().
    - Shop re-renders on 'boardExpanded' event to update/remove the expansion option.

  CSS (style.css):
    - #board-wrapper changed to flex-direction: column so expand button appears below board.
    - .board-expand-btn: subtle dashed-border pill, gold text, gems-color cost badge.
      Hover/active states with opacity and scale transitions.
    - .expand-cost styled in --gems-color (purple) for visual consistency with gem prices.
    - @keyframes expand-cell-pop: gold-to-default-bg animation for newly added cells.
    - CSS grid-template-columns/rows kept as defaults in CSS (6/8) but overridden by JS
      on init and expansion for variable board sizes.

2026-02-12 â€” Task 12: Gem sinks: creature evolution + cosmetic tiles
  Two new gem sink systems absorbing up to 2,400+ gems total per player. Combined with
  Task 11's board expansion (3,500 gems), total gem sinks now exceed 5,900 gems across
  all progression paths.

  Files modified: js/creatures.js, js/hatchery.js, js/shop.js, js/game.js, js/board.js, css/tiles.css
  Files modified (minor): PRD.md (marked task [x])

  (a) Creature evolution system (creatures.js + hatchery.js):
    - EVOLUTION_COST by rarity: common 200, uncommon 350, rare 500, legendary 800 gems.
    - Evolved creatures get 1.75x passive bonus multiplier (gem_bonus, discovery_chance,
      energy_regen, xp_bonus, spawn_quality all scaled).
    - Evolved creatures get 25% faster companion trigger (trigger count * 0.75, floor'd,
      minimum 4 merges). E.g., rare companion triggers every 6 instead of 8 merges.
    - calculatePassiveBonuses() overridden to check evolvedCreatures{} in save state
      and apply the 1.75x multiplier for evolved creatures.
    - getEffectiveCompanionTrigger() computes reduced trigger count for evolved creatures.
    - onCompanionMerge() uses effective trigger count instead of base trigger.
    - renderCompanionBar() uses effective trigger count for cooldown ring display.
    - Companion modal shows "EVOLVED" tag and effective trigger count for evolved creatures.
    - Hatchery creature detail modal (hatchery.js showCreatureDetail):
      Shows "EVOLVED" badge on creature name when evolved.
      Displays evolved passive bonus value with "(1.75x evolved)" indicator.
      Displays reduced companion trigger with "(faster)" indicator.
      Shows golden "Evolve" button with gem cost when not yet evolved.
      Button grayed out with secondary styling when player can't afford.
      On successful evolution: plays celebration overlay, re-renders detail modal
      and hatchery collection to show new evolved state.
    - Hatchery collection grid: evolved creatures get gold border + subtle glow,
      gold name color for visual distinction.
    - State: evolvedCreatures{} keyed by creature ID â†’ { evolvedAt: timestamp }.

  (b) Cosmetic tile themes (game.js + board.js + tiles.css + shop.js):
    - 4 purchasable board themes at 300 gems each (1,200 gems total):
      Ocean Depths: deep blue (#0c2d48 / #143a52), cyan accents
      Enchanted Forest: dark green (#1a2e1a / #1e3a1e), green accents
      Crystal Cavern: deep purple (#1a1530 / #221a3e), purple accents
      Shadow Realm: near-black (#0a0a14 / #121218), crimson accents
    - Each theme overrides #board background, .cell background, .cell.selected glow,
      and .cell.valid-target highlight via CSS class .board-theme-{id} on #board.
    - BOARD_THEMES constant in game.js with id, name, icon, cost, desc per theme.
    - purchaseBoardTheme() deducts gems, adds to ownedThemes, sets as active, emits event.
    - setBoardTheme() switches between owned themes (including null for default).
    - Board.init() applies saved theme on load via applyBoardTheme().
    - Board listens for 'boardThemeChanged' event to apply theme changes live.
    - applyBoardTheme() strips existing board-theme-* classes and adds new one.
    - Shop displays theme section with default + 4 themes:
      Owned themes show "Use" button or "ACTIVE" badge.
      Unowned themes show gem cost purchase button.
      Re-renders on 'boardThemeChanged' event to update active state.
    - State: boardTheme (string|null), ownedThemes{} keyed by theme ID.

  (c) Shop integration (shop.js):
    - Creature Evolution section: shows up to 6 evolvable creatures sorted by rarity
      (legendary first). Each row shows emoji, name, rarity, cost, and evolve button.
      Hidden when no creatures are available to evolve.
    - Board Themes section: shows default + 4 themes with purchase/use/active state.
    - Shop re-renders on 'creatureEvolved' and 'boardThemeChanged' events.

  (d) Save system (game.js):
    - SAVE_VERSION bumped from 3 to 4.
    - migrateState() v3â†’v4: adds evolvedCreatures{}, boardTheme null, ownedThemes{}.
    - defaultState() includes all three new fields.

2026-02-12 â€” Task 13: Economy number rebalancing
  Applied specific economy cuts from playtest analysis to reduce free gem income and fix
  broken energy refill incentives. Combined with Tasks 4/11/12 gem sinks, these source
  cuts create meaningful spending pressure.

  Files modified: js/daily.js, js/shop.js, js/island.js, js/game.js

  (a) Daily login calendar gem rewards reduced 40% (daily.js):
    - Day 1: 25 â†’ 15 gems
    - Day 2: 15 â†’ 10 gems (energy unchanged at 3)
    - Day 3: 50 â†’ 30 gems
    - Day 4: 25 â†’ 15 gems (energy unchanged at 5)
    - Day 5: 100 â†’ 60 gems (star unchanged at 1)
    - Day 6: 50 â†’ 30 gems (common egg unchanged)
    - Day 7: 250 â†’ 150 gems (stars and rare egg unchanged)
    - Weekly gem total: 515 â†’ 310 gems (60% of original).
    - Monthly projection: ~1,330 â†’ ~800 gems (matches PRD target of 800/month).
    - Streak multiplier system unchanged (still caps at 2x after 28 days).
    - Non-gem rewards (energy, stars, eggs) preserved to maintain daily login motivation.

  (b) Battle Pass free track gem cap at 800 (pass.js â€” no change needed):
    - Current free track total is 540 gems (120 from tiers 1-10, 420 from tiers 11-25).
    - Already well below the 800 gem cap specified in the PRD.
    - The PRD's "currently 1,690" figure was from pre-Task-10 calculations. Task 10
      already extended the season to 30 days and adjusted XP rates but didn't change
      reward amounts. The 540 total is the correct current value.

  (c) Energy refill cost increased from 35 to 75 gems (shop.js):
    - Full Recharge: 35 â†’ 75 gems (still gives full 100 energy).
    - Energy Pack (5 energy for 20 gems): unchanged â€” already net-negative.
    - At 35 gems, a full recharge was net-positive: 100 energy â†’ ~100 merges â†’ roughly
      40-60 gems from tier 4+ merges + events + surge bonuses. ROI was ~2x.
    - At 75 gems, a full recharge is now net-negative: 100 merges yield ~20-40 gems
      (after Task 4's tier threshold raise), well below the 75 gem cost.

  (d) Early island node gems reduced 50% (island.js):
    - First 15 nodes (Shore + Whispering Woods + first 4 of Sunlit Meadows):
      Shore: 10/12/15/18/50 â†’ 5/6/8/10/25 (boss halved too)
      Woods: 15/18/20/22/25/50 â†’ 8/10/10/12/12/25 (boss halved too)
      Meadows (first 4): 20/22/25/28 â†’ 10/12/12/15
    - Total first 15 nodes: 350 â†’ 180 gems (~49% reduction, matches PRD "50%" target).
    - Later regions (Stone Peaks, Crystal Depths, Cloud Realm, Ancient Ruins) unchanged.
    - Star requirements unchanged â€” progression pacing stays the same.

  (e) Energy refill net-positive fix:
    - Addressed by (c): raising Full Recharge cost from 35 to 75 gems makes energy
      refill clearly net-negative. A full 100-energy cycle produces ~20-40 gems from
      merges (post-Task 4 tier-4+ threshold), well below the 75 gem cost.
    - The Small Energy Pack (5 energy / 20 gems) was already net-negative.
    - Combined with Task 4's gem threshold raise (tier 3â†’4), active play gem income
      per energy point is further reduced, reinforcing the net-negative energy refill.

  (f) Save version bump (game.js):
    - SAVE_VERSION raised from 4 to 5.
    - migrateState() v4â†’v5: stamps version only (no save data migration needed,
      these are gameplay rule changes not save format changes).

2026-02-12 â€” Task 14: Pity timer for creature eggs + legendary weight
  Three changes to improve creature discovery fairness and reduce frustration for
  players who spend gems on creature eggs without seeing legendaries.

  Files modified: js/hatchery.js, js/shop.js, js/game.js

  (a) Pity counter: guaranteed legendary every 30 egg discoveries (hatchery.js):
    - PITY_THRESHOLD constant set to 30.
    - pityCounter tracked in save state at state.hatchery.pityCounter.
    - On every creature discovery (via merge, order bonus, shop biome egg, or
      undiscovered biome egg), the pity counter increments by 1.
    - When a legendary creature is discovered (by any means), the counter resets to 0.
    - When the counter reaches 29 (i.e., 29 non-legendary discoveries), the next
      discovery from a tier 4+ merge (where legendary rarity is accessible) is
      forced to legendary rarity. If no undiscovered legendary exists in available
      biomes, falls back to other rarities.
    - getPityCounter() and setPityCounter() helper functions read/write from
      Game.getState().hatchery.pityCounter.
    - saveState() now preserves pityCounter alongside discovered map.
    - Pity counter is lazily initialized to 0 for existing saves (in init() and
      in migrateState v5â†’v6).
    - Exposed via Hatchery.getPityCounter() and Hatchery.PITY_THRESHOLD for
      future UI display (e.g., "Legendary guaranteed in X more discoveries").

  (b) Legendary discovery weight increased from 3% to 8% (hatchery.js):
    - RARITY_WEIGHTS.legendary changed from 3 to 8.
    - RARITY_WEIGHTS.common reduced from 60 to 55 to compensate (total stays 100).
    - At 3%, players needed ~767 discoveries for all 23 legendaries (85-130 hours).
    - At 8%, expected discoveries per legendary drops from ~33 to ~12.5.
    - Combined with the pity timer (guaranteed at 30), the worst-case scenario
      is now 30 discoveries per legendary instead of theoretically infinite.

  (c) Undiscovered Biome Egg added to shop (shop.js):
    - 5 new shop items in 'undiscovered_eggs' category, one per biome:
      Meadow (500g), Forest (500g), Ocean (700g), Enchanted (1200g), Celestial (1800g).
    - Each is priced at 2x the regular biome egg for the same biome.
    - discoverUndiscoveredBiomeCreature() function: picks a random undiscovered
      creature from the specified biome. Guarantees the player gets a creature
      they haven't found yet (unlike regular biome eggs which can pick any creature).
    - Shop rendering: "Undiscovered Biome Eggs" section shown only for biomes
      that still have undiscovered creatures. Each item shows remaining count
      (e.g., "Guaranteed new Meadow creature (12 left)").
    - Section hidden entirely when all biomes are fully discovered.
    - Shop re-renders on 'creatureDiscovered' event to keep counts current.
    - Both discoverBiomeCreature() and discoverUndiscoveredBiomeCreature()
      update the pity counter (reset on legendary, increment otherwise).

  (d) Save version bump (game.js):
    - SAVE_VERSION raised from 5 to 6.
    - migrateState() v5â†’v6: adds pityCounter to hatchery state if missing,
      initializes to 0.

2026-02-12 â€” Task 15: AdAdapter module + energy-empty bottom sheet
  Created the ad infrastructure module and non-blocking energy-empty monetization
  bottom sheet. This is the first monetization insertion point, placing ad and gem
  refill options at the moment of highest player motivation (energy depletion).

  Files created: js/ad-adapter.js, css/ad-adapter.css
  Files modified: index.html, js/board.js, js/shop.js

  (a) AdAdapter IIFE module (js/ad-adapter.js):
    - AdAdapter.show(type, callback): simulates a 3-second ad with visual overlay
      (progress bar, countdown timer, film clapper icon). Callback receives true
      on completion, false on failure/cap exceeded.
    - AD_TYPE constants: REWARDED_ENERGY (energy refill), REWARDED_DOUBLE (future
      Task 16 double gem reward).
    - Simulated ad overlay: dark full-screen overlay with animated progress bar
      and 3-second countdown. Will be replaced by real SDK (AdMob/IronSource) later.
    - Events emitted: 'adStarted', 'adCompleted', 'adSkipped' via Game event bus
      for analytics integration.

  (b) Rewarded ad daily cap at 5/day (js/ad-adapter.js):
    - MAX_REWARDED_ADS_PER_DAY = 5 to protect IAP value.
    - Ad state tracked in Game.getState().adAdapter: { adsToday, adDate }.
    - Counter resets automatically on new calendar day (ISO date comparison).
    - canShowRewarded(), getAdsRemaining(), getAdsWatchedToday() query functions
      exposed for UI display.

  (c) Energy-empty bottom sheet (js/ad-adapter.js + css/ad-adapter.css):
    - Non-blocking bottom sheet slides up from screen bottom when energy is zero.
    - Two options: "Watch Ad" (free full recharge) and "Buy Refill" (75 gems).
    - Dismissible by tapping backdrop (outside sheet) or swiping down.
    - Watch Ad button shows remaining ads (e.g., "3/5 left today"), disabled when
      cap reached. Buy Refill shows gem cost, disabled when can't afford.
    - After ad: full energy recharge + celebration sound + haptic feedback + toast.
    - After gem purchase: 75 gems deducted + full recharge + purchase sound + toast.
    - 10-second cooldown after dismissal prevents re-showing on rapid spawn taps.
    - Duplicate prevention: won't show if already visible (DOM ID check).
    - CSS: subtle dark palette matching game theme, smooth slide-up animation,
      swipe-to-dismiss gesture support, safe-area-inset-bottom for notched phones.
      Respects prefers-reduced-motion.

  (d) Integration points:
    - board.js spawnItem(): when energy insufficient (non-cluttered), calls
      AdAdapter.showEnergyBottomSheet() via typeof guard. Cluttered boards keep
      their existing clutter-specific messaging instead.
    - Game 'energyEmpty' event: AdAdapter.init() registers a listener as fallback
      for any edge case where useEnergy() is called with 0 energy.
    - shop.js simulateRewardedAd(): now routes through AdAdapter.show() when
      available, respecting the 5/day cap. Falls back to direct simulation if
      AdAdapter is not loaded.
    - shop.js renderShop(): Watch Ad section now shows remaining ad count
      (e.g., "3/5 left today") and disables button when cap is reached.

  (e) Script loading (index.html):
    - ad-adapter.js loaded after game.js (dependency) and before board.js/shop.js.
    - css/ad-adapter.css linked in head alongside other feature CSS files.
    - AdAdapter.init() called after Shop.init() in initialization sequence.
