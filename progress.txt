2026-02-12 â€” Task 1: Fix 3 critical bugs
  (a) Audio clipping: DynamicsCompressorNode was already in place in js/audio.js (lines 15-26).
      Compressor chain: oscillators â†’ compressor (threshold -12dB, ratio 8:1) â†’ masterGain (0.85) â†’ destination.
      No change needed â€” verified working.
  (b) Worker/companion mutual exclusion: Added guard in assignWorker() (js/island.js:531) to reject
      creatures that are currently companions. Added reverse guard in equipCompanion() (js/creatures.js:369)
      to reject creatures that are currently workers. Both UI modals already filtered correctly; these
      guards protect the function-level API from bypasses.
  (c) double_reward companion ability: Fixed max-tier merge path (js/board.js:812) which previously
      gave hardcoded 10 gems without checking/consuming the double_reward flag. Now applies 2x multiplier
      and shows "2x COMPANION!" floating text. The flag already correctly persists past tier 1-2 merges
      (those merges don't enter the gem-reward block and don't consume the flag).

2026-02-12 â€” Task 2: Wire event modifiers into gameplay
  All 8 event modifier types are now read by gameplay code at their respective insertion points.
  Previously, Events module defined modifiers but no other module queried them â€” they were dead code.

  Files modified: js/board.js, js/game.js, js/hatchery.js

  Insertion point 1 â€” Gem rewards (board.js):
    - gem_multiplier: Applied to both regular merge gems (tier 3+) and max-tier merge gems.
      Chain-specific: only activates for the matching chain (e.g., Crystal Rush â†’ crystal merges only).
    - crosschain_reward_multiplier: Added base gem reward for cross-chain merges (tier-scaled),
      then multiplied by event value (e.g., Chain Master 3x).

  Insertion point 2 â€” Item spawning (board.js + hatchery.js):
    - spawn_tier_boost: After normal spawn tier calculation (including creature spawn quality bonus),
      adds the event boost value to the spawn tier, capped at max tier. Chain-specific.
    - discovery_boost: Applied in hatchery.js onItemProduced() â€” multiplies creature discovery
      chance by event value (e.g., Discovery Week 2x). Applied after creature passive bonuses.

  Insertion point 3 â€” Merge count thresholds (board.js):
    - min_merge_override: Replaced all 10 usages of the MIN_MERGE constant with getEffectiveMinMerge()
      which queries Events for an active min_merge_override. Affects: attemptMerge, swipe-merge,
      chain reactions, auto-merges, mass match, shuffle scan, companion pair finding.
      Makes Merge Mania ("All merges need only 2 items!") functional.

  Insertion point 4 â€” Energy regeneration (game.js):
    - energy_regen_multiplier: Divides regen interval by event value (e.g., Speed Demon halves
      the time). Applied after creature passive energy regen bonus. Floor of 30s minimum.

  Additional insertion points:
    - surge_boost: feedSurge() now accepts a chain parameter. When Stone Surge is active,
      surge gain is multiplied by event value for matching chain merges.
    - chain_reaction_boost: checkChainReaction() now gives a 50% bonus roll when connected
      items are 1 below the merge threshold during an active chain_reaction_boost event for
      the matching chain. This makes chain reactions "2x more likely" for Flora Festival.

  All event queries use typeof guards (typeof Events !== 'undefined') for safety.
  Events.hasModifier(type, chain) and Events.getModifierValue(type, chain) are the query API.

2026-02-12 â€” Task 3: Harden save system
  All 5 requirements implemented in js/game.js. No other files modified â€” the public API
  (Game.save()) is unchanged so all 21 external call sites work without modification.

  Files modified: js/game.js

  (a) 200ms debounce on Game.save() with beforeunload flush:
    - save() now sets a savePending flag and starts a 200ms setTimeout. Rapid calls within
      the window are coalesced into a single write. This prevents the 3-5 writes/sec during
      fast merging that Engineering flagged (synthesis score: 2/5 for save robustness).
    - flushSave() performs the actual write immediately and clears the timer.
    - beforeunload listener registered in init() calls flushSave() to ensure no pending
      state is lost when the player closes the tab or navigates away.
    - resetGame() calls flushSave() directly (not debounced) since a full state reset
      must be written immediately.

  (b) Save format version number:
    - Added _saveVersion: 1 to defaultState() and stamped on every flushSave().
    - migrateState() function ready for future version migrations (e.g., when Task 4
      changes MIN_MERGE or Task 11 adds board expansion, save format can be migrated).
    - SAVE_VERSION constant exported as Game.SAVE_VERSION for other modules.

  (c) Backup to haven-backup key:
    - After every successful primary write to 'haven_save', the same JSON is written
      to 'haven-backup'. Backup failure is logged but doesn't block the primary save.

  (d) Try/catch with fallback to backup:
    - load() tries primary key first via loadFromKey(). If primary is missing or corrupted
      (parse error, missing board/stats), falls back to loadFromKey(BACKUP_KEY).
    - On successful backup restore, heals the primary key from backup data.
    - Both loadFromKey() and flushSave() are fully wrapped in try/catch.
    - saveFailed event emitted on write failure for future UI notification.

  (e) Quota check before save:
    - estimateLocalStorageUsage() enumerates all localStorage keys and sums their
      UTF-16 byte sizes. Called before each write in flushSave().
    - If total usage + save size exceeds 4.5MB (QUOTA_WARN_BYTES), logs a warning
      and emits saveQuotaWarning event with byte counts for future UI display.
    - Does not block the save â€” just warns. The actual QuotaExceededError from
      localStorage.setItem() is caught by the existing try/catch.

2026-02-12 â€” Task 4: Raise thresholds: merge gems + MIN_MERGE
  Two related economy tightening changes that reduce free gem income ~30% and add strategic
  tension to merging. Both were agreed in the Phase 2 compromise (sinks before source cuts).

  Files modified: js/board.js, js/game.js

  (a) Raise gem-award tier from 3 to 4 (board.js:912):
    - Changed `if (nextTier >= 3)` to `if (nextTier >= 4)` in executeMerge().
    - Rebased gem formula from `Math.pow(1.8, nextTier - 3)` to `Math.pow(1.8, nextTier - 4)`
      so tier 4 now gets the base reward (1 gem) that tier 3 used to get.
    - Tier 3 merges no longer award gems at all â€” they still get screen-shake celebration
      (line 906, unchanged) but no gem reward.
    - Max-tier merge gems (line 829) were already tier-agnostic (flat 10 gems) â€” unchanged.
    - double_reward companion ability now naturally persists through tier 3 merges (they no
      longer enter the gem block, so the flag isn't consumed until a tier 4+ merge awards gems).
    - Event gem_multiplier still applies to the new tier 4+ rewards â€” no change needed.

  (b) Raise MIN_MERGE from 2 to 3 (board.js:7):
    - Changed `var MIN_MERGE = 2` to `var MIN_MERGE = 3`.
    - Players must now merge 3+ matching items instead of 2. This eliminates the trivial
      "pair merge" that removed strategic tension (flagged in PRD).
    - The Merge Mania event (min_merge_override: 2) now becomes a meaningful bonus â€” during
      the event, players CAN merge pairs again, which was previously a no-op.
    - All 10 usages of MIN_MERGE already go through getEffectiveMinMerge() (from Task 2),
      so the event override system works correctly with the new base value.
    - Affects: attemptMerge, swipe-merge, chain reactions, auto-merges, mass match,
      shuffle scan, companion pair finding, lucky auto-merge, near-miss highlighting.

  (c) Save version bump (game.js):
    - SAVE_VERSION raised from 1 to 2.
    - migrateState() updated: v1 saves are stamped to v2 on load. No data migration
      needed â€” these are gameplay rule changes, not save format changes.
    - defaultState() will now stamp new saves as v2.

2026-02-12 â€” Task 5: Celebration overlay system
  Built a shared, configurable full-screen celebration overlay and brief banner system.
  One module (js/celebration.js) with a data-driven config structure serves all trigger types.

  Files created: js/celebration.js, css/celebration.css
  Files modified: index.html, js/board.js, js/hatchery.js, js/pass.js, js/events.js, js/recipes.js

  Architecture:
    - Celebration IIFE module with CONFIGS data structure mapping 7 trigger types to display settings.
    - Two display modes: 'overlay' (full-screen, z-index 80) and 'banner' (brief top pill, z-index 75).
    - All overlays are tap-skippable and auto-dismiss (3s for overlays, 1.5s for banners).
    - Each config specifies: type, title, subtitle, icon, gradient colors, sound, duration, showShare.
    - Title/subtitle/icon/gradient can be static values or functions of the trigger data.

  Trigger types wired:
    (a) maxTierMerge (overlay): Fires in board.js executeMerge() when isMaxTier is true.
        Shows chain name + "chain mastered!" with item symbol emoji.
    (b) highTierMerge (overlay): Fires in board.js executeMerge() for tier 7+ regular merges.
        Shows "TIER 7!" with item symbol and chain name.
    (c) midTierMerge (banner): Fires in board.js executeMerge() for tier 5-6 merges.
        Brief top banner instead of full-screen (fires too frequently during surge).
        Enhanced particle burst (legendary) already existed; banner adds visual text feedback.
    (d) creatureDiscovery (overlay): Fires in hatchery.js showDiscoveryModal().
        Shows creature emoji, name, rarity. Includes Web Share API share button.
        Falls back to clipboard copy on devices without Web Share API.
        Existing detailed creature modal remains underneath for discovery count + biome info.
    (e) hybridUnlock (overlay): Fires in recipes.js showDiscoveryAnimation().
        Replaces the old hand-built recipe discovery overlay with the shared celebration system.
        Keeps the recipe book button pulse effect.
    (f) battlePassTier (overlay): Fires in pass.js claimTierReward().
        Shows reward-type emoji (gems/energy/stars/egg/powerup).
    (g) eventTier (overlay): Fires in events.js claimTier().
        Shows tier label (Bronze/Silver/Gold) + event name + event icon.

  Share button (creature discovery only):
    - Uses navigator.share() (Web Share API) if available.
    - Falls back to navigator.clipboard.writeText() with toast confirmation.
    - Shares: "I just discovered [name] in Haven! [emoji] #HavenGame"

  CSS (celebration.css):
    - Full overlay: dark backdrop, centered card with shimmer effect, icon bounce animation,
      gradient title, tap-hint text. Smooth scale+fade transitions for enter/exit.
    - Brief banner: absolute positioned pill at top, gradient background, slide-down entrance.
    - Respects prefers-reduced-motion media query.

  Safety:
    - All trigger sites use typeof Celebration !== 'undefined' guards.
    - When Celebration is unavailable, falls back to existing Sound/vibrate calls.
    - celebration.js loads after particles.js (for Particles.emit access at call time)
      and before game.js. No load-time dependencies on other modules.

2026-02-12 â€” Task 6: Item discovery rewards
  Award gems for every NEW item tier a player discovers for the first time. Creates constant
  micro-dopamine hits throughout early and mid-game (competitive gap: Travel Town's most
  addictive feature).

  Files modified: js/board.js, js/audio.js, js/game.js

  Gem rewards by rarity bracket (PRD spec):
    - Common (tiers 0-2): 5 gems
    - Uncommon (tiers 3-4): 10 gems
    - Rare (tiers 5-6): 25 gems
    - Legendary (tiers 7+): 50 gems
    (Previous implementation awarded only 1/2/3 gems â€” far too low for dopamine hit)

  Distinct chime sound (audio.js):
    - Added playItemDiscovery(): bright ascending C6-E6-G6 triad with sparkle shimmer.
    - Shorter and lighter than playCreatureDiscover() â€” appropriate for frequent micro-rewards.
    - Exported from Sound module, called via typeof guard for safety.

  Floating text:
    - Shows "+X NEW!" at the cell where the item was produced (not generic board center).
    - Toast shows "New Discovery: [Item Name] ([Chain]) +X gems" with magnifying glass icon.

  Discovery tracking (save state):
    - discoveredItems{} added to Game.defaultState() for new saves.
    - Existing saves get discoveredItems initialized lazily (null-guard in checkItemDiscovery).
    - Key format: "chain_tier" â†’ timestamp. Persists across sessions.
    - itemsDiscovered stat tracked for future achievement integration.

  All item production paths now trigger discovery check:
    - Regular merge result (executeMerge â†’ checkItemDiscovery)
    - Max-tier merge (executeMerge isMaxTier path â€” previously returned early before check)
    - Cross-chain merge result (executeCrossChainMerge)
    - Upgrade Wand power-up (upgradeItem)
    - Companion free_spawn effect (executeCompanionEffect)
    - Resource node spawns (spawnItem)
    - Starter items (spawnStarterItems â€” first-play tutorial items)
    Discovery only fires once per chain+tier combo; duplicate calls are no-ops.

2026-02-12 â€” Task 7: Toast queue with cooldown + surge tooltip
  Replaced the simple fire-and-forget showToast() with a priority-based queue system
  that prevents post-tutorial toast fatigue, and added a contextual surge tooltip.

  Files modified: js/board.js, js/celebration.js, index.html

  (a) Toast queue with priority ranking and cooldown:
    - Four priority levels: CRITICAL (100), HIGH (80), NORMAL (50), LOW (20).
    - CRITICAL and HIGH bypass all cooldowns â€” show immediately (surge activation,
      board full, no merges, lucky merge, surge end).
    - NORMAL respects a 45-second cooldown between toasts. If cooldown hasn't elapsed,
      the toast is queued (max 3 items). When queue is full, lowest priority is dropped.
      Queued toasts drain automatically when cooldown expires, highest priority first.
    - LOW (for future recipe hints) requires 90 seconds of complete toast silence before
      showing. Silently dropped if the quiet period hasn't elapsed.
    - Queue drain is scheduled via setTimeout â€” no polling.
    - displayToast() properly tracks the current toast element and dismiss timer to
      prevent orphaned DOM elements when a new toast replaces an existing one.

  Priority assignments for all 10 internal toast call sites:
    - CRITICAL: board full, no merges possible (free shuffle), surge tooltip
    - HIGH: surge activated, surge ended, lucky auto-merge
    - NORMAL: cluttered board, no energy (available merges), companion effect,
      item discovery, energy low (from index.html), clipboard copy (from celebration.js)

  (b) Contextual surge tooltip â€” first surge after tutorial:
    - On first surge activation after tutorial completion (state.firstPlay === false
      and state.surgeTooltipShown !== true), shows educational tooltip:
      "ðŸ’¡ You triggered SURGE! Merge fast to keep it going!"
    - Fires 2.2 seconds after surge toast so the SURGE MODE! toast is seen first.
    - Sets state.surgeTooltipShown = true and saves, so it never fires again.
    - Uses CRITICAL priority to bypass cooldown (it's a one-time educational moment).
    - state.surgeTooltipShown is lazily initialized (undefined â†’ falsy for new saves,
      true for saves after first surge). No defaultState() change needed.

  (c) Exported showToast and TOAST_PRIORITY from Board module:
    - Board.showToast(msg, priority) now available to external callers.
    - Board.TOAST_PRIORITY exposes priority constants (CRITICAL/HIGH/NORMAL/LOW).
    - index.html and celebration.js updated to pass priority parameter.
    - Previously these callers used Board.showToast but it wasn't exported â€”
      the typeof guard made them silently fail. Now they work correctly.

2026-02-12 â€” Task 8: Tutorial improvements
  Three additions to the tutorial and post-tutorial flow that improve onboarding and
  surface a critical currency (stars) on the main board screen.

  Files modified: js/tutorial.js, index.html, css/style.css

  (a) Swipe-merge tutorial step (tutorial.js):
    - Added new 'swipe-merge' step after 'first-merge' in the STEPS array.
    - Instruction: "Now try swiping! Drag your finger across 3+ matching items to
      merge them all at once." â€” teaches the game's most satisfying input method.
    - setupSwipeMerge() function: sets forcedSpawnTier(0) to spawn tier-0 wood items,
      suppresses auto-merge so the player can practice swiping manually, and spawns
      3 wood items via Board.spawnItem('wood') to create adjacent swipe opportunities.
    - Step advances on 'mergeCompleted' event (same as first-merge step).
    - Board spotlight targets the board-wrapper so the full grid is interactive.

  (b) Cross-chain recipe hint tooltip (tutorial.js):
    - Just-in-time guidance that fires when a player first has recipe ingredients
      adjacent on the board (e.g., wood tier 1 next to flora tier 1).
    - startRecipeHintListener() registers on 'mergeCompleted' and 'itemSpawned' events.
    - checkForAdjacentRecipe() scans all board cells and their 4 orthogonal neighbors,
      calling Items.getCrossChainResult() on each pair. If an undiscovered recipe pair
      is found, shows a toast via Board.showToast() with LOW priority (respects 90s
      silence requirement from Task 7's toast queue system).
    - Toast message: "[icon] + [icon] Drag one onto the other to discover a new recipe!"
    - state.recipeHintShown flag persisted to save state â€” hint fires only once ever.
    - Listener starts both for new players (after tutorial completes, in
      showPostTutorialBreadcrumbs) and for existing players (in start() when
      firstPlay is false and recipeHintShown is falsy).

  (c) Stars display in top bar (index.html + css/style.css):
    - Added #stars-display element to the top bar, placed before #gems-display in
      the right-side flex container. Shows star emoji + count.
    - CSS: shares styling with #energy-display and #gems-display (pill shape,
      dark background, rounded borders). Color: var(--accent-gold). Min-width: 50px.
    - Event listener: 'starsChanged' updates #stars-count text and plays brief
      scale(1.1) flash animation (same pattern as gems display).
    - Initial value set from Game.getStars() during initialization.
    - Stars are now visible on the main board screen at all times â€” previously only
      visible in Island/Quest tabs. This was flagged as a critical gap: stars are
      the primary progression currency but were invisible during core gameplay.
